SET @QueryString = '
SELECT 
    b.wi_name AS "WorkItem Number",
    b.Service_Request_Type AS "Service Request Type",
    CHAR(39) + b.cif_id AS "CIF ID",
    CHAR(39) + b.Agreement_Number AS "Agreement Number",
    CHAR(39) + b.ERCN_Number AS "ECRN Number",
    b.Pre_Paid_Pack_Id AS "Prepaid pack ID",
    b.IntiatorUserGroup AS "Initiating Team",
    b.IntoducedBy AS "Introduced By",
    b.IntoducedAt AS "Introduced Date",
    b.current_ws AS "Current Workstep",
    CASE 
        WHEN b.CURRENT_WS IN (''Exit'', ''Reject'') THEN ''NA'' 
        ELSE b.Team 
    END AS "Current Team Assigned",

    -- OUTER APPLY to get top history row once
    History.wsname AS "Last Actioned Workstep (Team)",
    History.username AS "Last Actioned By (Team)",
    History.decision AS "Last Decision (Team)",
    AssignInfo.assigneddatetime AS "Last Entry Datetime (Team)",
    History.actiondatetime AS "Last Action Datetime (Team)",
    History.remarks AS "Last Remarks (Team)",
    rakcas.dbo.[getRejectReasons_SRO](History.rejectreasons, ''SRO'') AS "Last Reject Reason",

    CurrentStep.entrydatetime AS "Current Workstep Entrydatetime",
    CASE 
        WHEN b.current_ws NOT IN (''Exit'', ''Reject'') THEN rakcas.dbo.[GetTatCalculation_SRO](CurrentStep.entrydatetime, GETDATE())
        ELSE ''NA''
    END AS "Current Queue Ageing"

FROM rakcas.dbo.RB_SRO_EXTTABLE b WITH (NOLOCK)

-- JOIN with filtered history once
INNER JOIN (
    SELECT DISTINCT winame
    FROM rakcas.dbo.RAK_V_SRO_received_History WITH (NOLOCK)
    WHERE 
        teamassigned = ''' + @Team + '''
        AND CONVERT(DATE, assigneddatetime, 102) BETWEEN CONVERT(DATE, ''' + @FromDate + ''', 102)
        AND CONVERT(DATE, ''' + @ToDate + ''', 102)
        AND identifier = ''Assigned''
) AS FilteredHistory ON b.wi_name = FilteredHistory.winame

-- APPLY to get assignment info
OUTER APPLY (
    SELECT MAX(g.assigneddatetime) AS assigneddatetime
    FROM rakcas.dbo.RAK_V_SRO_received_History g WITH (NOLOCK)
    WHERE 
        g.winame = b.wi_name
        AND g.teamassigned = ''' + @Team + '''
        AND g.identifier = ''Assigned''
) AS AssignInfo

-- APPLY to get most recent action details
OUTER APPLY (
    SELECT TOP 1 
        f.wsname,
        f.username,
        f.decision,
        f.remarks,
        f.rejectreasons,
        f.actiondatetime
    FROM rakcas.dbo.RAK_V_SRO_received_History f WITH (NOLOCK)
    WHERE 
        f.winame = b.wi_name
        AND f.[Last Team Assigned] = ''' + @Team + '''
        AND f.wsname IN (''checker'', ''Maker'')
        AND f.actiondatetime > AssignInfo.assigneddatetime
    ORDER BY f.actiondatetime DESC
) AS History

-- APPLY to get current workstep entry datetime
OUTER APPLY (
    SELECT TOP 1 ENTRYDATETIME
    FROM rakcas.dbo.USR_0_SRO_WIHISTORY WITH (NOLOCK)
    WHERE 
        WINAME = b.wi_name
        AND ACTIONDATETIME IS NULL
    ORDER BY ENTRYDATETIME DESC
) AS CurrentStep
'
