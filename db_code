select

        b.wi_name,

        b.Service_Request_Type,

        CHAR(39)+b.cif_id,

        CHAR(39)+b.Agreement_Number,

        CHAR(39)+b.ERCN_Number,

        b.Pre_Paid_Pack_Id,

        b.IntiatorUserGroup,

        b.IntoducedBy,

        b.IntoducedAt,

        b.current_ws,

        (CASE WHEN CURRENT_WS IN (''Exit'',''Reject'') then ''NA'' ELSE Team END) CURRENTTEAM,
 
        -- ActionedBy = wsname (from latest action after assigned)

        ISNULL(latest.wsname, '''') ActionedBy,
 
        -- ActionedBy = username (same alias as original; returns username from same latest action row)

        ISNULL(latest.username, '''') ActionedBy,
 
        ISNULL(latest.decision, '''') decision,
 
        assigned.max_assigneddatetime entrydatetime,
 
        latest.actiondatetime,
 
        ISNULL(latest.remarks, '''') remarks,
 
        rakcas.dbo.[getRejectReasons_SRO](ISNULL(latest.rejectreasons, ''''),''SRO'') rejectreasons,
 
        (SELECT TOP 1 ENTRYDATETIME

            FROM rakcas.dbo.USR_0_SRO_WIHISTORY with (nolock)

            WHERE WINAME = b.WI_NAME AND ACTIONDATETIME IS NULL

            ORDER BY ENTRYDATETIME DESC) ,
 
        (case when b.current_ws not in (''Exit'',''Reject'') then 

            rakcas.dbo.[GetTatCalculation_SRO](

                (SELECT TOP 1 ENTRYDATETIME

                    FROM rakcas.dbo.USR_0_SRO_WIHISTORY with (nolock)

                    WHERE WINAME = B.WI_NAME AND ACTIONDATETIME IS NULL

                    ORDER BY ENTRYDATETIME DESC),

                getdate()

            )

         else ''NA'' END) AGEING
 
    from rakcas.[dbo].[RB_SRO_EXTTABLE] b WITH(NOLOCK)
 
    -- compute the latest assigned datetime (single aggregated lookup)

    OUTER APPLY (

        select max(g.assigneddatetime) as max_assigneddatetime

        from rakcas.dbo.RAK_V_SRO_received_History g with(nolock)

        where g.winame = b.wi_name

          and (g.teamassigned = ''' + @Team + ''')

          and g.identifier = ''Assigned''

    ) assigned
 
    -- pick the top 1 action row that is after the assigned datetime and is from the given team & wsname in checker/maker

    OUTER APPLY (

        select top 1

            f.wsname,

            f.username,

            f.decision,

            f.actiondatetime,

            f.remarks,

            f.rejectreasons

        from rakcas.dbo.RAK_V_SRO_received_History f with(nolock)

        where f.winame = b.wi_name

          and f.''Last Team Assigned'' = ''' + @Team + '''

          and f.wsname in (''checker'', ''Maker'')

          and f.actiondatetime > ISNULL(assigned.max_assigneddatetime, '''' /* NULL-safe */)

        order by f.actiondatetime desc

    ) latest
 
    where b.wi_name in (

        select winame

        from rakcas.dbo.RAK_V_SRO_received_History a WITH(NOLOCK)

        where a.teamassigned = ''' + @Team + '''

          and CONVERT(DATE, a.assigneddatetime, 102) between

              CONVERT(DATE, ''' + @FromDate + ''' , 102) and CONVERT(DATE, ''' + @ToDate + ''' , 102)

          and a.identifier = ''Assigned''

    )
 
